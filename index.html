<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Chia S·∫ª M√†n H√¨nh</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 900px;
            width: 100%;
            padding: 40px;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2em;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #eee;
        }

        .tab {
            padding: 15px 30px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            color: #666;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .input-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }

        input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .code-display {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            margin: 20px 0;
        }

        .code-display .code {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
            letter-spacing: 5px;
        }

        .video-container {
            position: relative;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
            margin-top: 20px;
        }

        video {
            width: 100%;
            display: block;
        }

        .status {
            padding: 10px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
            font-weight: 500;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
        }

        .hidden {
            display: none;
        }

        .viewer-count {
            background: #667eea;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            text-align: center;
            margin: 15px 0;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .viewer-count .count {
            font-size: 24px;
            font-weight: bold;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .control-btn {
            flex: 1;
            padding: 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .control-btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        .control-btn.active {
            background: #28a745;
        }

        .control-btn.muted {
            background: #dc3545;
        }

        .chat-container {
            background: #f8f9fa;
            border-radius: 8px;
            margin-top: 20px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 300px;
        }

        .chat-header {
            background: #667eea;
            color: white;
            padding: 12px 15px;
            font-weight: 600;
        }

        .chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .chat-message {
            padding: 8px 12px;
            border-radius: 8px;
            max-width: 80%;
            word-wrap: break-word;
        }

        .chat-message.own {
            background: #667eea;
            color: white;
            align-self: flex-end;
            margin-left: auto;
        }

        .chat-message.other {
            background: #e9ecef;
            color: #333;
            align-self: flex-start;
        }

        .chat-message .sender {
            font-size: 11px;
            opacity: 0.8;
            margin-bottom: 3px;
        }

        .chat-message .text {
            font-size: 14px;
        }

        .chat-input-container {
            display: flex;
            gap: 10px;
            padding: 15px;
            border-top: 1px solid #dee2e6;
            background: white;
        }

        .chat-input-container input {
            flex: 1;
            margin: 0;
        }

        .chat-input-container button {
            width: auto;
            padding: 12px 20px;
        }

        /* Floating Chat Window */
        .floating-chat {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 350px;
            max-height: 500px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            display: none;
            flex-direction: column;
            z-index: 1000;
        }

        .floating-chat.show {
            display: flex;
        }

        .floating-chat-header {
            background: #667eea;
            color: white;
            padding: 15px;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: move;
        }

        .floating-chat-header .title {
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .floating-chat-header .close-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }

        .floating-chat-header .close-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .floating-chat .chat-messages {
            height: 300px;
        }

        .chat-toggle-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #667eea;
            color: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 999;
            transition: all 0.3s;
        }

        .chat-toggle-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(0,0,0,0.4);
        }

        .chat-toggle-btn.show {
            display: flex;
        }

        .chat-toggle-btn .badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #dc3545;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        /* Camera overlay */
        .camera-overlay {
            position: absolute;
            bottom: 15px;
            right: 15px;
            width: 180px;
            height: 135px;
            border-radius: 8px;
            overflow: hidden;
            border: 3px solid #667eea;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
            z-index: 10;
            background: #000;
        }

        .camera-overlay video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Nhi·ªÅu camera overlays */
        .camera-overlay:nth-child(2) {
            bottom: 160px; /* ƒê·∫∑t camera th·ª© 2 ph√≠a tr√™n */
        }

        .camera-overlay:nth-child(3) {
            bottom: 305px; /* ƒê·∫∑t camera th·ª© 3 ph√≠a tr√™n n·ªØa */
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .container {
                padding: 20px;
                border-radius: 15px;
            }

            h1 {
                font-size: 1.5em;
                margin-bottom: 20px;
            }

            .tabs {
                gap: 5px;
            }

            .tab {
                padding: 12px 20px;
                font-size: 14px;
            }

            button {
                padding: 12px;
                font-size: 14px;
            }

            .controls {
                flex-direction: column;
                gap: 8px;
            }

            .control-btn {
                width: 100%;
                padding: 12px;
                font-size: 14px;
            }

            .code-display .code {
                font-size: 24px;
                letter-spacing: 3px;
            }

            .viewer-count {
                padding: 8px 15px;
                font-size: 14px;
            }

            .viewer-count .count {
                font-size: 20px;
            }

            .chat-container {
                height: 250px;
            }

            .chat-messages {
                padding: 10px;
                gap: 8px;
            }

            .chat-message {
                font-size: 13px;
                padding: 6px 10px;
            }

            .chat-input-container {
                padding: 10px;
                gap: 8px;
            }

            .chat-input-container input {
                font-size: 14px;
                padding: 10px;
            }

            .chat-input-container button {
                padding: 10px 15px;
                font-size: 14px;
            }

            .camera-overlay {
                width: 120px;
                height: 90px;
                bottom: 10px;
                right: 10px;
            }

            .camera-overlay:nth-child(2) {
                bottom: 110px;
            }

            .floating-chat {
                width: 100%;
                max-width: 100%;
                height: 100%;
                max-height: 100%;
                bottom: 0;
                right: 0;
                border-radius: 0;
            }

            .chat-toggle-btn {
                width: 50px;
                height: 50px;
                font-size: 20px;
                bottom: 15px;
                right: 15px;
            }

            .chat-toggle-btn .badge {
                width: 20px;
                height: 20px;
                font-size: 11px;
            }
        }

        /* Landscape mobile */
        @media (max-width: 768px) and (orientation: landscape) {
            .container {
                padding: 15px;
            }

            .chat-container {
                height: 200px;
            }

            .controls {
                flex-direction: row;
            }

            .control-btn {
                flex: 1;
            }
        }

        /* Touch-friendly */
        @media (hover: none) and (pointer: coarse) {
            button, .control-btn, .tab {
                min-height: 44px; /* iOS recommended touch target */
            }

            input {
                font-size: 16px; /* Prevent zoom on iOS */
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üñ•Ô∏è Chia S·∫ª M√†n H√¨nh</h1>
        
        <div class="tabs">
            <button class="tab active" onclick="switchTab('share')">Chia S·∫ª</button>
            <button class="tab" onclick="switchTab('view')">Xem</button>
        </div>

        <!-- Tab Chia S·∫ª -->
        <div id="share-tab" class="tab-content active">
            <div id="share-setup">
                <div class="input-group">
                    <label for="host-name-input">T√™n c·ªßa b·∫°n:</label>
                    <input type="text" id="host-name-input" placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n" maxlength="20">
                </div>
                <p style="color: #666; margin-bottom: 20px;">
                    Nh·∫•n n√∫t b√™n d∆∞·ªõi ƒë·ªÉ b·∫Øt ƒë·∫ßu chia s·∫ª m√†n h√¨nh c·ªßa b·∫°n
                </p>
                <button onclick="startSharing()">B·∫Øt ƒê·∫ßu Chia S·∫ª</button>
            </div>

            <div id="share-active" class="hidden">
                <div class="status success">
                    ‚úì ƒêang chia s·∫ª m√†n h√¨nh
                </div>
                <div class="status info">
                    ‚ö†Ô∏è <strong>Demo Mode:</strong> Ng∆∞·ªùi xem ph·∫£i m·ªü tr√™n <strong>c√πng thi·∫øt b·ªã n√†y</strong> (m·ªü tab m·ªõi). 
                    Kh√¥ng th·ªÉ xem t·ª´ ƒëi·ªán tho·∫°i/m√°y kh√°c.
                </div>
                <div class="code-display">
                    <p style="margin-bottom: 10px; color: #666;">M√£ chia s·∫ª c·ªßa b·∫°n:</p>
                    <div class="code" id="share-code">----</div>
                    <p style="margin-top: 10px; font-size: 14px; color: #666;">
                        üì± ƒê·ªÉ xem t·ª´ thi·∫øt b·ªã kh√°c, c·∫ßn deploy l√™n server
                    </p>
                </div>
                <div class="viewer-count">
                    <span>üë• Ng∆∞·ªùi ƒëang xem:</span>
                    <span class="count" id="viewer-count">0</span>
                </div>
                <div class="video-container">
                    <video id="local-video" autoplay muted></video>
                </div>
                <div class="controls">
                    <button class="control-btn" id="mic-btn-host" onclick="toggleMicrophone('host')">
                        üé§ B·∫≠t Micro
                    </button>
                    <button class="control-btn" id="cam-btn-host" onclick="toggleCamera('host')">
                        üìπ B·∫≠t Camera
                    </button>
                    <button class="control-btn" id="float-chat-btn-host" onclick="openChatPopup()">
                        üí¨ M·ªü Chat Popup
                    </button>
                </div>
                <div class="chat-container">
                    <div class="chat-header">üí¨ Chat</div>
                    <div class="chat-messages" id="chat-messages-host"></div>
                    <div class="chat-input-container">
                        <input type="text" id="chat-input-host" placeholder="Nh·∫≠p tin nh·∫Øn..." onkeypress="if(event.key==='Enter') sendMessage('host')">
                        <button onclick="sendMessage('host')">G·ª≠i</button>
                    </div>
                </div>
                <button onclick="stopSharing()" style="margin-top: 20px; background: #dc3545;">
                    D·ª´ng Chia S·∫ª
                </button>
            </div>
        </div>

        <!-- Tab Xem -->
        <div id="view-tab" class="tab-content">
            <div id="view-setup">
                <div class="status info">
                    ‚ö†Ô∏è <strong>L∆∞u √Ω:</strong> Hi·ªán t·∫°i ch·ªâ ho·∫°t ƒë·ªông tr√™n <strong>c√πng m·ªôt thi·∫øt b·ªã</strong> (demo mode). 
                    ƒê·ªÉ xem t·ª´ thi·∫øt b·ªã kh√°c, c·∫ßn deploy l√™n server v·ªõi WebSocket.
                </div>
                <div class="input-group">
                    <label for="viewer-name-input">T√™n c·ªßa b·∫°n:</label>
                    <input type="text" id="viewer-name-input" placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n" maxlength="20">
                </div>
                <div class="input-group">
                    <label for="code-input">Nh·∫≠p m√£ chia s·∫ª:</label>
                    <input type="text" id="code-input" placeholder="Nh·∫≠p m√£ 4 ch·ªØ s·ªë" maxlength="4">
                </div>
                <button onclick="joinSession()">K·∫øt N·ªëi</button>
                
                <div style="margin-top: 20px; padding: 15px; background: #e7f3ff; border-radius: 8px; font-size: 14px;">
                    <strong>üí° C√°ch test tr√™n c√πng thi·∫øt b·ªã:</strong><br>
                    1. M·ªü tab m·ªõi (Ctrl+T)<br>
                    2. M·ªü l·∫°i file index.html<br>
                    3. Tab 1: Chia s·∫ª ‚Üí L·∫•y m√£<br>
                    4. Tab 2: Xem ‚Üí Nh·∫≠p m√£
                </div>
            </div>

            <div id="view-active" class="hidden">
                <div class="status success">
                    ‚úì ƒê√£ k·∫øt n·ªëi
                </div>
                <div class="video-container">
                    <video id="remote-video" autoplay></video>
                </div>
                <div class="controls">
                    <button class="control-btn" id="mic-btn-viewer" onclick="toggleMicrophone('viewer')">
                        üé§ B·∫≠t Micro
                    </button>
                    <button class="control-btn" id="cam-btn-viewer" onclick="toggleCamera('viewer')">
                        üìπ B·∫≠t Camera
                    </button>
                </div>
                <div class="chat-container">
                    <div class="chat-header">üí¨ Chat</div>
                    <div class="chat-messages" id="chat-messages-viewer"></div>
                    <div class="chat-input-container">
                        <input type="text" id="chat-input-viewer" placeholder="Nh·∫≠p tin nh·∫Øn..." onkeypress="if(event.key==='Enter') sendMessage('viewer')">
                        <button onclick="sendMessage('viewer')">G·ª≠i</button>
                    </div>
                </div>
                <button onclick="leaveSession()" style="margin-top: 20px; background: #dc3545;">
                    Ng·∫Øt K·∫øt N·ªëi
                </button>
            </div>

            <div id="view-status" class="hidden"></div>
        </div>
    </div>

    <!-- Floating Chat Window -->
    <div id="floating-chat" class="floating-chat">
        <div class="floating-chat-header">
            <div class="title">
                üí¨ Chat
                <span id="unread-badge" style="display: none; background: #dc3545; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px; margin-left: 5px;">0</span>
            </div>
            <button class="close-btn" onclick="toggleFloatingChat()">√ó</button>
        </div>
        <div class="chat-messages" id="floating-chat-messages"></div>
        <div class="chat-input-container">
            <input type="text" id="floating-chat-input" placeholder="Nh·∫≠p tin nh·∫Øn..." onkeypress="if(event.key==='Enter') sendFloatingMessage()">
            <button onclick="sendFloatingMessage()">G·ª≠i</button>
        </div>
    </div>

    <!-- Chat Toggle Button -->
    <button id="chat-toggle-btn" class="chat-toggle-btn" onclick="toggleFloatingChat()">
        üí¨
        <span id="chat-badge" class="badge" style="display: none;">0</span>
    </button>

    <script>
        // C·∫•u h√¨nh WebRTC
        const configuration = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' }
            ]
        };

        let localStream = null;
        let peerConnection = null;
        let sessionCode = null;
        let isSharing = false;
        let viewerCountInterval = null;
        let audioStream = null;
        let isMicOn = false;
        let chatCheckInterval = null;
        let userRole = null; // 'host' ho·∫∑c 'viewer'
        let userName = ''; // T√™n ng∆∞·ªùi d√πng
        let cameraStream = null;
        let isCameraOn = false;
        let isFloatingChatOpen = false;
        let unreadMessages = 0;

        // Chuy·ªÉn tab
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            if (tab === 'share') {
                document.querySelector('.tab:first-child').classList.add('active');
                document.getElementById('share-tab').classList.add('active');
            } else {
                document.querySelector('.tab:last-child').classList.add('active');
                document.getElementById('view-tab').classList.add('active');
            }
        }

        // T·∫°o m√£ ng·∫´u nhi√™n 4 ch·ªØ s·ªë
        function generateCode() {
            return Math.floor(1000 + Math.random() * 9000).toString();
        }

        // B·∫Øt ƒë·∫ßu chia s·∫ª m√†n h√¨nh
        async function startSharing() {
            // L·∫•y t√™n ng∆∞·ªùi d√πng
            const nameInput = document.getElementById('host-name-input').value.trim();
            if (!nameInput) {
                alert('Vui l√≤ng nh·∫≠p t√™n c·ªßa b·∫°n');
                return;
            }
            userName = nameInput;

            try {
                // Y√™u c·∫ßu quy·ªÅn chia s·∫ª m√†n h√¨nh
                localStream = await navigator.mediaDevices.getDisplayMedia({
                    video: {
                        cursor: 'always'
                    },
                    audio: false
                });

                // Hi·ªÉn th·ªã video local
                document.getElementById('local-video').srcObject = localStream;

                // T·∫°o m√£ chia s·∫ª
                sessionCode = generateCode();
                document.getElementById('share-code').textContent = sessionCode;

                // L∆∞u th√¥ng tin session v√†o localStorage (gi·∫£ l·∫≠p server)
                const sessionData = {
                    code: sessionCode,
                    timestamp: Date.now(),
                    active: true
                };
                localStorage.setItem(`session_${sessionCode}`, JSON.stringify(sessionData));

                // Chuy·ªÉn giao di·ªán
                document.getElementById('share-setup').classList.add('hidden');
                document.getElementById('share-active').classList.remove('hidden');
                isSharing = true;

                // L·∫Øng nghe s·ª± ki·ªán d·ª´ng chia s·∫ª
                localStream.getVideoTracks()[0].onended = () => {
                    stopSharing();
                };

                // B·∫Øt ƒë·∫ßu l·∫Øng nghe y√™u c·∫ßu k·∫øt n·ªëi
                startListeningForConnections();

                // B·∫Øt ƒë·∫ßu c·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng ng∆∞·ªùi xem
                startViewerCountUpdate();

                // Thi·∫øt l·∫≠p role v√† b·∫Øt ƒë·∫ßu chat
                userRole = 'host';
                startChatSync();

                // Hi·ªÉn th·ªã n√∫t chat n·ªïi
                document.getElementById('chat-toggle-btn').classList.add('show');

            } catch (error) {
                alert('Kh√¥ng th·ªÉ chia s·∫ª m√†n h√¨nh: ' + error.message);
            }
        }

        // B·∫≠t/t·∫Øt camera
        async function toggleCamera(role) {
            const btnId = role === 'host' ? 'cam-btn-host' : 'cam-btn-viewer';
            const btn = document.getElementById(btnId);

            if (!isCameraOn) {
                try {
                    cameraStream = await navigator.mediaDevices.getUserMedia({ 
                        video: { 
                            width: { ideal: 640 },
                            height: { ideal: 480 }
                        },
                        audio: false 
                    });

                    console.log('Camera stream created:', cameraStream.id);

                    // Hi·ªÉn th·ªã camera c·ªßa m√¨nh (preview)
                    const videoId = role === 'host' ? 'local-video' : 'remote-video';
                    const videoContainer = document.getElementById(videoId)?.parentElement;
                    if (videoContainer) {
                        const cameraOverlay = document.createElement('div');
                        cameraOverlay.className = 'camera-overlay';
                        cameraOverlay.id = `camera-overlay-self-${role}`;
                        cameraOverlay.style.bottom = '15px';
                        cameraOverlay.style.left = '15px'; // B√™n tr√°i ƒë·ªÉ ph√¢n bi·ªát v·ªõi camera ng∆∞·ªùi kh√°c
                        cameraOverlay.style.right = 'auto';
                        
                        const cameraVideo = document.createElement('video');
                        cameraVideo.autoplay = true;
                        cameraVideo.muted = true;
                        cameraVideo.srcObject = cameraStream;
                        
                        cameraOverlay.appendChild(cameraVideo);
                        videoContainer.appendChild(cameraOverlay);
                    }

                    // Th√™m camera track v√†o peer connection
                    if (peerConnection && peerConnection.connectionState !== 'closed') {
                        const sender = peerConnection.addTrack(cameraStream.getVideoTracks()[0], cameraStream);
                        console.log('Added camera track to peer connection:', sender.track.label);
                        
                        // L∆∞u sender ƒë·ªÉ c√≥ th·ªÉ remove sau
                        if (!window.cameraSenders) window.cameraSenders = [];
                        window.cameraSenders.push(sender);
                    } else {
                        console.warn('Peer connection not ready');
                    }

                    isCameraOn = true;
                    btn.classList.add('active');
                    btn.innerHTML = 'üìπ T·∫Øt Camera';
                } catch (error) {
                    console.error('Camera error:', error);
                    alert('Kh√¥ng th·ªÉ truy c·∫≠p camera: ' + error.message);
                }
            } else {
                if (cameraStream) {
                    // Stop t·∫•t c·∫£ tracks tr∆∞·ªõc
                    cameraStream.getTracks().forEach(track => {
                        console.log('Stopping camera track:', track.label);
                        track.stop();
                    });

                    // X√≥a camera tracks kh·ªèi peer connection
                    if (peerConnection) {
                        const senders = peerConnection.getSenders();
                        senders.forEach(sender => {
                            if (sender.track && cameraStream.getVideoTracks().includes(sender.track)) {
                                console.log('Removing camera track from peer connection');
                                peerConnection.removeTrack(sender);
                            }
                        });
                    }

                    cameraStream = null;
                }

                // X√≥a camera overlay c·ªßa m√¨nh
                const cameraOverlay = document.getElementById(`camera-overlay-self-${role}`);
                if (cameraOverlay) {
                    console.log('Removing self camera overlay');
                    cameraOverlay.remove();
                }

                // Th√¥ng b√°o cho peer r·∫±ng camera ƒë√£ t·∫Øt
                localStorage.setItem(`camera_off_${sessionCode}_${role}`, Date.now().toString());

                isCameraOn = false;
                btn.classList.remove('active');
                btn.innerHTML = 'üìπ B·∫≠t Camera';
            }
        }

        // Hi·ªÉn th·ªã camera overlay t·ª´ remote stream
        function showRemoteCameraOverlay(stream, role) {
            // role ·ªü ƒë√¢y l√† role c·ªßa ng∆∞·ªùi g·ª≠i camera
            const videoId = role === 'host' ? 'remote-video' : 'local-video'; // Ng∆∞·ª£c l·∫°i
            const videoContainer = document.getElementById(videoId)?.parentElement;
            
            if (!videoContainer) return;

            // X√≥a overlay c≈© n·∫øu c√≥
            const oldOverlay = document.getElementById(`camera-overlay-remote-${role}`);
            if (oldOverlay) {
                oldOverlay.remove();
            }

            // T·∫°o camera overlay m·ªõi
            const cameraOverlay = document.createElement('div');
            cameraOverlay.className = 'camera-overlay';
            cameraOverlay.id = `camera-overlay-remote-${role}`;
            
            const cameraVideo = document.createElement('video');
            cameraVideo.autoplay = true;
            cameraVideo.muted = true;
            cameraVideo.srcObject = stream;
            
            cameraOverlay.appendChild(cameraVideo);
            videoContainer.appendChild(cameraOverlay);
        }

        // X√≥a camera overlay t·ª´ remote
        function removeRemoteCameraOverlay(role) {
            const overlay = document.getElementById(`camera-overlay-remote-${role}`);
            if (overlay) {
                overlay.remove();
            }
        }

        // M·ªü chat trong c·ª≠a s·ªï popup
        let chatPopupWindow = null;
        let popupCheckInterval = null;

        function openChatPopup() {
            if (!sessionCode) {
                alert('Vui l√≤ng b·∫Øt ƒë·∫ßu chia s·∫ª tr∆∞·ªõc');
                return;
            }

            // ƒê√≥ng popup c≈© n·∫øu c√≥
            if (chatPopupWindow && !chatPopupWindow.closed) {
                chatPopupWindow.focus();
                return;
            }

            // T·∫°o HTML cho popup
            const popupHTML = `
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat - ${sessionCode}</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .chat-header {
            background: #667eea;
            color: white;
            padding: 15px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
            background: white;
        }
        .chat-message {
            padding: 8px 12px;
            border-radius: 8px;
            max-width: 80%;
            word-wrap: break-word;
        }
        .chat-message.own {
            background: #667eea;
            color: white;
            align-self: flex-end;
            margin-left: auto;
        }
        .chat-message.other {
            background: #e9ecef;
            color: #333;
            align-self: flex-start;
        }
        .chat-message .sender {
            font-size: 11px;
            opacity: 0.8;
            margin-bottom: 3px;
        }
        .chat-message .text {
            font-size: 14px;
        }
        .chat-input-container {
            display: flex;
            gap: 10px;
            padding: 15px;
            background: white;
            border-top: 1px solid #dee2e6;
        }
        .chat-input-container input {
            flex: 1;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }
        .chat-input-container input:focus {
            outline: none;
            border-color: #667eea;
        }
        .chat-input-container button {
            padding: 12px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }
        .chat-input-container button:hover {
            opacity: 0.9;
        }
        .unread-badge {
            background: #dc3545;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="chat-header">
        <div>üí¨ Chat - M√£: ${sessionCode}</div>
        <div id="unread-count" class="unread-badge" style="display: none;">0</div>
    </div>
    <div class="chat-messages" id="popup-chat-messages"></div>
    <div class="chat-input-container">
        <input type="text" id="popup-chat-input" placeholder="Nh·∫≠p tin nh·∫Øn..." onkeypress="if(event.key==='Enter') sendPopupMessage()">
        <button onclick="sendPopupMessage()">G·ª≠i</button>
    </div>

    <script>
        const sessionCode = '${sessionCode}';
        const userName = '${userName}';
        const userRole = '${userRole}';
        let lastMessageId = 0;

        // G·ª≠i tin nh·∫Øn
        function sendPopupMessage() {
            const input = document.getElementById('popup-chat-input');
            const message = input.value.trim();
            if (!message) return;

            const chatMessage = {
                id: Date.now() + Math.random(),
                sender: userName || 'User',
                text: message,
                timestamp: Date.now(),
                role: userRole
            };

            const messages = JSON.parse(localStorage.getItem('chat_' + sessionCode) || '[]');
            messages.push(chatMessage);
            localStorage.setItem('chat_' + sessionCode, JSON.stringify(messages));

            displayMessage(chatMessage);
            input.value = '';
        }

        // Hi·ªÉn th·ªã tin nh·∫Øn
        function displayMessage(message) {
            const messagesDiv = document.getElementById('popup-chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chat-message ' + (message.role === userRole ? 'own' : 'other');
            messageDiv.setAttribute('data-message-id', message.id);

            if (messagesDiv.querySelector('[data-message-id="' + message.id + '"]')) {
                return;
            }

            const senderDiv = document.createElement('div');
            senderDiv.className = 'sender';
            senderDiv.textContent = message.sender;

            const textDiv = document.createElement('div');
            textDiv.className = 'text';
            textDiv.textContent = message.text;

            messageDiv.appendChild(senderDiv);
            messageDiv.appendChild(textDiv);
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // ƒê·ªìng b·ªô tin nh·∫Øn
        function syncMessages() {
            const messages = JSON.parse(localStorage.getItem('chat_' + sessionCode) || '[]');
            const newMessages = messages.filter(m => m.id > lastMessageId);

            newMessages.forEach(message => {
                displayMessage(message);
                lastMessageId = Math.max(lastMessageId, message.id);
            });
        }

        // Load tin nh·∫Øn c≈©
        syncMessages();

        // ƒê·ªìng b·ªô m·ªói gi√¢y
        setInterval(syncMessages, 1000);

        // Th√¥ng b√°o khi ƒë√≥ng
        window.addEventListener('beforeunload', () => {
            if (window.opener && !window.opener.closed) {
                window.opener.chatPopupClosed();
            }
        });
    <\/script>
</body>
</html>`;

            // M·ªü popup
            chatPopupWindow = window.open('', 'ChatPopup', 'width=400,height=600,left=100,top=100');
            if (chatPopupWindow) {
                chatPopupWindow.document.write(popupHTML);
                chatPopupWindow.document.close();

                // Ki·ªÉm tra popup c√≥ b·ªã ƒë√≥ng kh√¥ng
                popupCheckInterval = setInterval(() => {
                    if (chatPopupWindow && chatPopupWindow.closed) {
                        clearInterval(popupCheckInterval);
                        chatPopupWindow = null;
                    }
                }, 1000);
            } else {
                alert('Kh√¥ng th·ªÉ m·ªü popup. Vui l√≤ng cho ph√©p popup trong tr√¨nh duy·ªát.');
            }
        }

        // Callback khi popup ƒë√≥ng
        function chatPopupClosed() {
            chatPopupWindow = null;
            if (popupCheckInterval) {
                clearInterval(popupCheckInterval);
                popupCheckInterval = null;
            }
        }

        // Toggle floating chat
        function toggleFloatingChat() {
            const floatingChat = document.getElementById('floating-chat');
            const toggleBtn = document.getElementById('chat-toggle-btn');
            
            isFloatingChatOpen = !isFloatingChatOpen;
            
            if (isFloatingChatOpen) {
                floatingChat.classList.add('show');
                toggleBtn.style.display = 'none';
                unreadMessages = 0;
                updateChatBadge();
                
                // ƒê·ªìng b·ªô t·∫•t c·∫£ tin nh·∫Øn v√†o floating chat khi m·ªü
                syncFloatingChatMessages();
            } else {
                floatingChat.classList.remove('show');
                toggleBtn.style.display = 'flex';
            }
        }

        // ƒê·ªìng b·ªô tin nh·∫Øn v√†o floating chat
        function syncFloatingChatMessages() {
            if (!sessionCode) return;
            
            const messages = JSON.parse(localStorage.getItem(`chat_${sessionCode}`) || '[]');
            const floatingMessagesDiv = document.getElementById('floating-chat-messages');
            
            // X√≥a t·∫•t c·∫£ tin nh·∫Øn c≈©
            floatingMessagesDiv.innerHTML = '';
            
            // Hi·ªÉn th·ªã l·∫°i t·∫•t c·∫£ tin nh·∫Øn
            messages.forEach(message => {
                displayFloatingMessage(message);
            });
        }

        // G·ª≠i tin nh·∫Øn t·ª´ floating chat
        function sendFloatingMessage() {
            const input = document.getElementById('floating-chat-input');
            const message = input.value.trim();

            if (!message || !sessionCode) return;

            const chatMessage = {
                id: Date.now() + Math.random(), // ID unique h∆°n
                sender: userName || (userRole === 'host' ? 'Host' : 'Viewer'),
                text: message,
                timestamp: Date.now(),
                role: userRole
            };

            // L∆∞u tin nh·∫Øn v√†o localStorage
            const messages = JSON.parse(localStorage.getItem(`chat_${sessionCode}`) || '[]');
            messages.push(chatMessage);
            localStorage.setItem(`chat_${sessionCode}`, JSON.stringify(messages));

            // Hi·ªÉn th·ªã tin nh·∫Øn c·ªßa m√¨nh trong floating chat
            displayFloatingMessage(chatMessage);
            
            // Hi·ªÉn th·ªã tin nh·∫Øn c·ªßa m√¨nh trong chat th∆∞·ªùng
            displayMessage(chatMessage, userRole);

            // X√≥a input
            input.value = '';
        }

        // Hi·ªÉn th·ªã tin nh·∫Øn trong floating chat
        function displayFloatingMessage(message) {
            const messagesDiv = document.getElementById('floating-chat-messages');

            if (!messagesDiv) return; // Ki·ªÉm tra element t·ªìn t·∫°i

            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${message.role === userRole ? 'own' : 'other'}`;
            messageDiv.setAttribute('data-message-id', message.id); // Th√™m ID ƒë·ªÉ tr√°nh tr√πng
            
            // Ki·ªÉm tra tin nh·∫Øn ƒë√£ t·ªìn t·∫°i ch∆∞a
            if (messagesDiv.querySelector(`[data-message-id="${message.id}"]`)) {
                return; // Tin nh·∫Øn ƒë√£ t·ªìn t·∫°i, kh√¥ng th√™m n·ªØa
            }

            const senderDiv = document.createElement('div');
            senderDiv.className = 'sender';
            senderDiv.textContent = message.sender;
            
            const textDiv = document.createElement('div');
            textDiv.className = 'text';
            textDiv.textContent = message.text;

            messageDiv.appendChild(senderDiv);
            messageDiv.appendChild(textDiv);
            messagesDiv.appendChild(messageDiv);

            // Scroll xu·ªëng cu·ªëi
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // C·∫≠p nh·∫≠t badge s·ªë tin nh·∫Øn ch∆∞a ƒë·ªçc
        function updateChatBadge() {
            const badge = document.getElementById('chat-badge');
            const unreadBadge = document.getElementById('unread-badge');
            
            if (unreadMessages > 0) {
                badge.textContent = unreadMessages;
                badge.style.display = 'flex';
                unreadBadge.textContent = unreadMessages;
                unreadBadge.style.display = 'inline';
            } else {
                badge.style.display = 'none';
                unreadBadge.style.display = 'none';
            }
        }

        // B·∫≠t/t·∫Øt microphone
        async function toggleMicrophone(role) {
            const btnId = role === 'host' ? 'mic-btn-host' : 'mic-btn-viewer';
            const btn = document.getElementById(btnId);

            if (!isMicOn) {
                try {
                    audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    
                    // Th√™m audio track v√†o peer connection n·∫øu ƒë√£ c√≥
                    if (peerConnection) {
                        audioStream.getAudioTracks().forEach(track => {
                            peerConnection.addTrack(track, audioStream);
                        });
                    }

                    isMicOn = true;
                    btn.classList.add('active');
                    btn.innerHTML = 'üé§ T·∫Øt Micro';
                } catch (error) {
                    alert('Kh√¥ng th·ªÉ truy c·∫≠p microphone: ' + error.message);
                }
            } else {
                if (audioStream) {
                    audioStream.getTracks().forEach(track => track.stop());
                    audioStream = null;
                }
                isMicOn = false;
                btn.classList.remove('active');
                btn.innerHTML = 'üé§ B·∫≠t Micro';
            }
        }

        // G·ª≠i tin nh·∫Øn chat
        function sendMessage(role) {
            const inputId = role === 'host' ? 'chat-input-host' : 'chat-input-viewer';
            const input = document.getElementById(inputId);
            const message = input.value.trim();

            if (!message || !sessionCode) return;

            const chatMessage = {
                id: Date.now() + Math.random(), // ID unique h∆°n
                sender: userName || (role === 'host' ? 'Host' : 'Viewer'),
                text: message,
                timestamp: Date.now(),
                role: role
            };

            // L∆∞u tin nh·∫Øn v√†o localStorage
            const messages = JSON.parse(localStorage.getItem(`chat_${sessionCode}`) || '[]');
            messages.push(chatMessage);
            localStorage.setItem(`chat_${sessionCode}`, JSON.stringify(messages));

            // Hi·ªÉn th·ªã tin nh·∫Øn c·ªßa m√¨nh trong chat th∆∞·ªùng
            displayMessage(chatMessage, role);

            // Hi·ªÉn th·ªã tin nh·∫Øn c·ªßa m√¨nh trong floating chat n·∫øu ƒëang m·ªü
            if (isFloatingChatOpen) {
                displayFloatingMessage(chatMessage);
            }

            // X√≥a input
            input.value = '';
        }

        // Hi·ªÉn th·ªã tin nh·∫Øn
        function displayMessage(message, currentRole) {
            const messagesId = currentRole === 'host' ? 'chat-messages-host' : 'chat-messages-viewer';
            const messagesDiv = document.getElementById(messagesId);

            if (!messagesDiv) return; // Ki·ªÉm tra element t·ªìn t·∫°i

            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${message.role === currentRole ? 'own' : 'other'}`;
            messageDiv.setAttribute('data-message-id', message.id); // Th√™m ID ƒë·ªÉ tr√°nh tr√πng
            
            // Ki·ªÉm tra tin nh·∫Øn ƒë√£ t·ªìn t·∫°i ch∆∞a
            if (messagesDiv.querySelector(`[data-message-id="${message.id}"]`)) {
                return; // Tin nh·∫Øn ƒë√£ t·ªìn t·∫°i, kh√¥ng th√™m n·ªØa
            }

            const senderDiv = document.createElement('div');
            senderDiv.className = 'sender';
            senderDiv.textContent = message.sender;
            
            const textDiv = document.createElement('div');
            textDiv.className = 'text';
            textDiv.textContent = message.text;

            messageDiv.appendChild(senderDiv);
            messageDiv.appendChild(textDiv);
            messagesDiv.appendChild(messageDiv);

            // Scroll xu·ªëng cu·ªëi
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // ƒê·ªìng b·ªô chat
        function startChatSync() {
            let lastMessageId = 0;
            let lastCameraCheck = {};

            chatCheckInterval = setInterval(() => {
                if (!sessionCode) return;

                const messages = JSON.parse(localStorage.getItem(`chat_${sessionCode}`) || '[]');
                const newMessages = messages.filter(m => m.id > lastMessageId);

                newMessages.forEach(message => {
                    // Ch·ªâ hi·ªÉn th·ªã tin nh·∫Øn c·ªßa ng∆∞·ªùi kh√°c
                    if (message.role !== userRole) {
                        // Hi·ªÉn th·ªã trong chat th∆∞·ªùng (trong container)
                        displayMessage(message, userRole);
                        
                        // Hi·ªÉn th·ªã trong floating chat n·∫øu ƒëang m·ªü
                        if (isFloatingChatOpen) {
                            displayFloatingMessage(message);
                        } else {
                            // TƒÉng s·ªë tin nh·∫Øn ch∆∞a ƒë·ªçc n·∫øu chat n·ªïi ƒëang ƒë√≥ng
                            unreadMessages++;
                            updateChatBadge();
                        }
                    }
                    lastMessageId = Math.max(lastMessageId, message.id);
                });

                // Ki·ªÉm tra tr·∫°ng th√°i camera c·ªßa ng∆∞·ªùi kh√°c
                const otherRole = userRole === 'host' ? 'viewer' : 'host';
                const cameraOffKey = `camera_off_${sessionCode}_${otherRole}`;
                const cameraOffTime = localStorage.getItem(cameraOffKey);
                
                if (cameraOffTime && (!lastCameraCheck[otherRole] || cameraOffTime !== lastCameraCheck[otherRole])) {
                    console.log('Detected camera off from', otherRole);
                    lastCameraCheck[otherRole] = cameraOffTime;
                    removeRemoteCameraOverlay(otherRole);
                }
            }, 1000);
        }

        // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng ng∆∞·ªùi xem
        function startViewerCountUpdate() {
            updateViewerCount();
            viewerCountInterval = setInterval(updateViewerCount, 2000);
        }

        function updateViewerCount() {
            if (!sessionCode) return;

            const viewers = JSON.parse(localStorage.getItem(`viewers_${sessionCode}`) || '[]');
            const now = Date.now();
            
            // L·ªçc nh·ªØng viewer c√≤n active (trong v√≤ng 5 gi√¢y)
            const activeViewers = viewers.filter(v => now - v.lastSeen < 5000);
            
            // C·∫≠p nh·∫≠t l·∫°i danh s√°ch
            localStorage.setItem(`viewers_${sessionCode}`, JSON.stringify(activeViewers));
            
            // Hi·ªÉn th·ªã s·ªë l∆∞·ª£ng
            document.getElementById('viewer-count').textContent = activeViewers.length;
        }

        // D·ª´ng chia s·∫ª
        function stopSharing() {
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }

            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }

            if (viewerCountInterval) {
                clearInterval(viewerCountInterval);
                viewerCountInterval = null;
            }

            if (chatCheckInterval) {
                clearInterval(chatCheckInterval);
                chatCheckInterval = null;
            }

            if (audioStream) {
                audioStream.getTracks().forEach(track => track.stop());
                audioStream = null;
            }

            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }

            // ƒê√≥ng chat popup n·∫øu c√≥
            if (chatPopupWindow && !chatPopupWindow.closed) {
                chatPopupWindow.close();
                chatPopupWindow = null;
            }
            if (popupCheckInterval) {
                clearInterval(popupCheckInterval);
                popupCheckInterval = null;
            }

            // X√≥a t·∫•t c·∫£ camera overlays
            const cameraOverlays = document.querySelectorAll('.camera-overlay');
            cameraOverlays.forEach(overlay => overlay.remove());

            if (sessionCode) {
                localStorage.removeItem(`session_${sessionCode}`);
                localStorage.removeItem(`offer_${sessionCode}`);
                localStorage.removeItem(`answer_${sessionCode}`);
                localStorage.removeItem(`viewers_${sessionCode}`);
                localStorage.removeItem(`chat_${sessionCode}`);
                localStorage.removeItem(`ice_host_${sessionCode}`);
                localStorage.removeItem(`ice_viewer_${sessionCode}`);
                sessionCode = null;
            }

            // ·∫®n floating chat v√† x√≥a tin nh·∫Øn
            document.getElementById('floating-chat').classList.remove('show');
            document.getElementById('chat-toggle-btn').classList.remove('show');
            document.getElementById('floating-chat-messages').innerHTML = '';
            document.getElementById('chat-messages-host').innerHTML = '';
            isFloatingChatOpen = false;
            unreadMessages = 0;

            document.getElementById('share-setup').classList.remove('hidden');
            document.getElementById('share-active').classList.add('hidden');
            document.getElementById('host-name-input').value = '';
            isMicOn = false;
            isCameraOn = false;
            userRole = null;
            userName = '';
            isSharing = false;
        }

        // L·∫Øng nghe y√™u c·∫ßu k·∫øt n·ªëi (gi·∫£ l·∫≠p signaling)
        function startListeningForConnections() {
            // T·∫°o offer ngay khi b·∫Øt ƒë·∫ßu chia s·∫ª
            createOfferForSession();

            let answerReceived = false;

            // L·∫Øng nghe answer t·ª´ viewer
            const checkInterval = setInterval(async () => {
                if (!isSharing) {
                    clearInterval(checkInterval);
                    return;
                }

                const answerData = localStorage.getItem(`answer_${sessionCode}`);
                if (answerData && peerConnection && peerConnection.signalingState === 'have-local-offer' && !answerReceived) {
                    answerReceived = true;
                    const answer = JSON.parse(answerData);
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
                    
                    // X·ª≠ l√Ω ICE candidates t·ª´ viewer
                    checkForViewerIceCandidates();
                }

                // L·∫Øng nghe offer m·ªõi t·ª´ viewer (khi viewer b·∫≠t camera)
                const viewerOfferData = localStorage.getItem(`viewer_offer_${sessionCode}`);
                if (viewerOfferData && peerConnection && peerConnection.signalingState === 'stable') {
                    console.log('Host received viewer offer (camera)');
                    const viewerOffer = JSON.parse(viewerOfferData);
                    
                    // X√≥a offer c≈© ƒë·ªÉ kh√¥ng x·ª≠ l√Ω l·∫°i
                    localStorage.removeItem(`viewer_offer_${sessionCode}`);
                    
                    // Set remote description v√† t·∫°o answer
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(viewerOffer));
                    const answer = await peerConnection.createAnswer();
                    await peerConnection.setLocalDescription(answer);
                    
                    // L∆∞u answer cho viewer
                    localStorage.setItem(`host_answer_${sessionCode}`, JSON.stringify(answer));
                }
            }, 1000);
        }

        // T·∫°o offer cho session
        async function createOfferForSession() {
            try {
                peerConnection = new RTCPeerConnection(configuration);

                // Th√™m local stream v√†o peer connection
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });

                // X·ª≠ l√Ω remote stream t·ª´ viewer (camera v√† audio)
                peerConnection.ontrack = (event) => {
                    const track = event.track;
                    
                    console.log('Host received track:', track.kind, track.label);

                    if (track.kind === 'video') {
                        // Camera t·ª´ viewer
                        const viewerCameraStream = new MediaStream([track]);
                        showRemoteCameraOverlay(viewerCameraStream, 'viewer');
                    } else if (track.kind === 'audio') {
                        // Audio t·ª´ viewer - ph√°t qua audio element
                        const audioElement = new Audio();
                        audioElement.srcObject = new MediaStream([track]);
                        audioElement.play().catch(e => console.log('Audio play error:', e));
                    }

                    // X·ª≠ l√Ω khi track k·∫øt th√∫c
                    track.onended = () => {
                        console.log('Host track ended:', track.kind);
                        if (track.kind === 'video') {
                            removeRemoteCameraOverlay('viewer');
                        }
                    };
                };

                // X·ª≠ l√Ω ICE candidates
                peerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        const candidates = JSON.parse(localStorage.getItem(`ice_host_${sessionCode}`) || '[]');
                        candidates.push(event.candidate);
                        localStorage.setItem(`ice_host_${sessionCode}`, JSON.stringify(candidates));
                    }
                };

                // X·ª≠ l√Ω negotiation needed (khi th√™m track m·ªõi)
                peerConnection.onnegotiationneeded = async () => {
                    try {
                        console.log('Host: Negotiation needed');
                        const offer = await peerConnection.createOffer();
                        await peerConnection.setLocalDescription(offer);
                        localStorage.setItem(`offer_${sessionCode}`, JSON.stringify(offer));
                    } catch (error) {
                        console.error('Negotiation error:', error);
                    }
                };

                // T·∫°o offer
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);

                // L∆∞u offer
                localStorage.setItem(`offer_${sessionCode}`, JSON.stringify(offer));

            } catch (error) {
                console.error('Error creating offer:', error);
            }
        }

        // Ki·ªÉm tra ICE candidates t·ª´ viewer
        function checkForViewerIceCandidates() {
            const checkInterval = setInterval(async () => {
                if (!isSharing) {
                    clearInterval(checkInterval);
                    return;
                }

                const candidates = JSON.parse(localStorage.getItem(`ice_viewer_${sessionCode}`) || '[]');
                for (const candidate of candidates) {
                    try {
                        await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
                    } catch (error) {
                        console.error('Error adding viewer ICE candidate:', error);
                    }
                }
                
                if (candidates.length > 0) {
                    localStorage.setItem(`ice_viewer_${sessionCode}`, JSON.stringify([]));
                }
            }, 1000);

            setTimeout(() => clearInterval(checkInterval), 30000);
        }

        // Tham gia session
        async function joinSession() {
            // L·∫•y t√™n ng∆∞·ªùi d√πng
            const nameInput = document.getElementById('viewer-name-input').value.trim();
            if (!nameInput) {
                showStatus('error', 'Vui l√≤ng nh·∫≠p t√™n c·ªßa b·∫°n');
                return;
            }
            userName = nameInput;

            const code = document.getElementById('code-input').value.trim();
            
            if (code.length !== 4) {
                showStatus('error', 'Vui l√≤ng nh·∫≠p m√£ 4 ch·ªØ s·ªë');
                return;
            }

            // Ki·ªÉm tra session c√≥ t·ªìn t·∫°i kh√¥ng
            const sessionData = localStorage.getItem(`session_${code}`);
            if (!sessionData) {
                showStatus('error', '‚ùå M√£ kh√¥ng h·ª£p l·ªá! L∆∞u √Ω: Ph·∫£i m·ªü tr√™n C√ôNG THI·∫æT B·ªä v·ªõi ng∆∞·ªùi chia s·∫ª (demo mode)');
                return;
            }

            try {
                sessionCode = code;
                
                // ƒê·ª£i offer t·ª´ host tr∆∞·ªõc
                showStatus('info', 'ƒêang k·∫øt n·ªëi...');
                await waitForOffer();

                // Chuy·ªÉn giao di·ªán
                document.getElementById('view-setup').classList.add('hidden');
                document.getElementById('view-active').classList.remove('hidden');

                // Thi·∫øt l·∫≠p role v√† b·∫Øt ƒë·∫ßu chat
                userRole = 'viewer';
                startChatSync();

                // L·∫Øng nghe answer t·ª´ host (khi viewer g·ª≠i offer m·ªõi)
                startListeningForHostAnswer();

            } catch (error) {
                showStatus('error', 'L·ªói k·∫øt n·ªëi: ' + error.message);
            }
        }

        // L·∫Øng nghe answer t·ª´ host
        function startListeningForHostAnswer() {
            const checkInterval = setInterval(async () => {
                if (!peerConnection || !sessionCode) {
                    clearInterval(checkInterval);
                    return;
                }

                const hostAnswerData = localStorage.getItem(`host_answer_${sessionCode}`);
                if (hostAnswerData && peerConnection.signalingState === 'have-local-offer') {
                    console.log('Viewer received host answer');
                    const hostAnswer = JSON.parse(hostAnswerData);
                    
                    // X√≥a answer ƒë·ªÉ kh√¥ng x·ª≠ l√Ω l·∫°i
                    localStorage.removeItem(`host_answer_${sessionCode}`);
                    
                    // Set remote description
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(hostAnswer));
                }
            }, 1000);
        }

        // ƒê·ª£i offer t·ª´ host
        function waitForOffer() {
            return new Promise((resolve, reject) => {
                const checkInterval = setInterval(async () => {
                    const offerData = localStorage.getItem(`offer_${sessionCode}`);
                    if (offerData) {
                        clearInterval(checkInterval);
                        
                        try {
                            // T·∫°o peer connection
                            peerConnection = new RTCPeerConnection(configuration);

                            // X·ª≠ l√Ω remote stream
                            let remoteVideoStream = new MediaStream();
                            let videoTrackCount = 0;

                            peerConnection.ontrack = (event) => {
                                const track = event.track;
                                const stream = event.streams[0];

                                console.log('Received track:', track.kind, track.label);

                                if (track.kind === 'video') {
                                    videoTrackCount++;
                                    
                                    if (videoTrackCount === 1) {
                                        // Track ƒë·∫ßu ti√™n l√† screen share
                                        remoteVideoStream.addTrack(track);
                                        document.getElementById('remote-video').srcObject = remoteVideoStream;
                                    } else {
                                        // C√°c track sau l√† camera
                                        const cameraStream = new MediaStream([track]);
                                        showRemoteCameraOverlay(cameraStream, 'host');
                                    }
                                } else if (track.kind === 'audio') {
                                    // Audio track
                                    remoteVideoStream.addTrack(track);
                                    const currentSrc = document.getElementById('remote-video').srcObject;
                                    if (currentSrc) {
                                        currentSrc.addTrack(track);
                                    }
                                }

                                // X·ª≠ l√Ω khi track k·∫øt th√∫c
                                track.onended = () => {
                                    console.log('Track ended:', track.kind, track.label);
                                    if (track.kind === 'video' && videoTrackCount > 1) {
                                        removeRemoteCameraOverlay('host');
                                    }
                                };
                            };

                            // X·ª≠ l√Ω ICE candidates
                            peerConnection.onicecandidate = (event) => {
                                if (event.candidate) {
                                    const candidates = JSON.parse(localStorage.getItem(`ice_viewer_${sessionCode}`) || '[]');
                                    candidates.push(event.candidate);
                                    localStorage.setItem(`ice_viewer_${sessionCode}`, JSON.stringify(candidates));
                                }
                            };

                            // X·ª≠ l√Ω negotiation needed (khi viewer th√™m camera)
                            peerConnection.onnegotiationneeded = async () => {
                                try {
                                    console.log('Viewer: Negotiation needed');
                                    const offer = await peerConnection.createOffer();
                                    await peerConnection.setLocalDescription(offer);
                                    // C·∫≠p nh·∫≠t answer m·ªõi
                                    const answer = await peerConnection.createAnswer();
                                    await peerConnection.setLocalDescription(answer);
                                    localStorage.setItem(`answer_${sessionCode}`, JSON.stringify(answer));
                                } catch (error) {
                                    console.error('Viewer negotiation error:', error);
                                }
                            };

                            // Set remote description (offer)
                            const offer = JSON.parse(offerData);
                            await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
                            
                            // T·∫°o answer
                            const answer = await peerConnection.createAnswer();
                            await peerConnection.setLocalDescription(answer);

                            // L∆∞u answer
                            localStorage.setItem(`answer_${sessionCode}`, JSON.stringify(answer));

                            // Ki·ªÉm tra ICE candidates t·ª´ host
                            checkForHostIceCandidates();

                            // ƒêƒÉng k√Ω viewer
                            registerViewer();
                            
                            resolve();
                        } catch (error) {
                            reject(error);
                        }
                    }
                }, 1000);

                setTimeout(() => {
                    clearInterval(checkInterval);
                    reject(new Error('Kh√¥ng t√¨m th·∫•y phi√™n chia s·∫ª'));
                }, 10000);
            });
        }

        // Ki·ªÉm tra ICE candidates t·ª´ host
        function checkForHostIceCandidates() {
            const checkInterval = setInterval(async () => {
                if (!peerConnection) {
                    clearInterval(checkInterval);
                    return;
                }

                const candidates = JSON.parse(localStorage.getItem(`ice_host_${sessionCode}`) || '[]');
                for (const candidate of candidates) {
                    try {
                        await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
                    } catch (error) {
                        console.error('Error adding host ICE candidate:', error);
                    }
                }
                
                if (candidates.length > 0) {
                    localStorage.setItem(`ice_host_${sessionCode}`, JSON.stringify([]));
                }
            }, 1000);

            setTimeout(() => clearInterval(checkInterval), 30000);
        }

        // ƒêƒÉng k√Ω viewer v√† c·∫≠p nh·∫≠t heartbeat
        let viewerHeartbeatInterval = null;
        const viewerId = 'viewer_' + Math.random().toString(36).substr(2, 9);

        function registerViewer() {
            updateViewerHeartbeat();
            viewerHeartbeatInterval = setInterval(updateViewerHeartbeat, 2000);
        }

        function updateViewerHeartbeat() {
            if (!sessionCode) return;

            const viewers = JSON.parse(localStorage.getItem(`viewers_${sessionCode}`) || '[]');
            const existingIndex = viewers.findIndex(v => v.id === viewerId);
            
            const viewerData = {
                id: viewerId,
                lastSeen: Date.now()
            };

            if (existingIndex >= 0) {
                viewers[existingIndex] = viewerData;
            } else {
                viewers.push(viewerData);
            }

            localStorage.setItem(`viewers_${sessionCode}`, JSON.stringify(viewers));
        }

        // R·ªùi kh·ªèi session
        function leaveSession() {
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }

            if (viewerHeartbeatInterval) {
                clearInterval(viewerHeartbeatInterval);
                viewerHeartbeatInterval = null;
            }

            if (chatCheckInterval) {
                clearInterval(chatCheckInterval);
                chatCheckInterval = null;
            }

            if (audioStream) {
                audioStream.getTracks().forEach(track => track.stop());
                audioStream = null;
            }

            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }

            // X√≥a t·∫•t c·∫£ camera overlays
            const cameraOverlays = document.querySelectorAll('.camera-overlay');
            cameraOverlays.forEach(overlay => overlay.remove());

            // X√≥a viewer kh·ªèi danh s√°ch
            if (sessionCode) {
                const viewers = JSON.parse(localStorage.getItem(`viewers_${sessionCode}`) || '[]');
                const filtered = viewers.filter(v => v.id !== viewerId);
                localStorage.setItem(`viewers_${sessionCode}`, JSON.stringify(filtered));
            }

            document.getElementById('remote-video').srcObject = null;
            document.getElementById('chat-messages-viewer').innerHTML = '';
            document.getElementById('view-setup').classList.remove('hidden');
            document.getElementById('view-active').classList.add('hidden');
            document.getElementById('code-input').value = '';
            document.getElementById('viewer-name-input').value = '';
            isMicOn = false;
            isCameraOn = false;
            userRole = null;
            userName = '';
            sessionCode = null;
        }

        // Hi·ªÉn th·ªã tr·∫°ng th√°i
        function showStatus(type, message) {
            const statusDiv = document.getElementById('view-status');
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = message;
            statusDiv.classList.remove('hidden');

            setTimeout(() => {
                statusDiv.classList.add('hidden');
            }, 5000);
        }

        // D·ªçn d·∫πp khi ƒë√≥ng trang
        window.addEventListener('beforeunload', () => {
            if (isSharing) {
                stopSharing();
            }
            if (peerConnection) {
                leaveSession();
            }
        });
    </script>
</body>
</html>
